name: Deploy to Homelab (Multi-VM)

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - 'scripts/**'
      - '.github/workflows/deploy-selfhosted.yml'

  workflow_dispatch:  # ErmÃ¶glicht manuelles Triggern Ã¼ber GitHub UI
    inputs:
      target_vm:
        description: 'Target VM (leave empty for all VMs)'
        required: false
        default: ''
      service:
        description: 'Specific service (leave empty for all services)'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: self-hosted  # LÃ¤uft auf deinem Runner!
    name: Deploy to Homelab VMs

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy to VMs
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          TARGET_VM: ${{ github.event.inputs.target_vm }}
          SERVICE: ${{ github.event.inputs.service }}
        run: |
          set -e
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Homelab Multi-VM Deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ–¥ï¸  Runner: $(hostname)"
          echo "ğŸ“‚ Workspace: $GITHUB_WORKSPACE"
          echo "ğŸ“Š Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo ""

          # Deployment-Skript ausfÃ¼hren
          cd $GITHUB_WORKSPACE/services/github-runner

          if [ -n "$TARGET_VM" ]; then
            # Spezifische VM deployen
            echo "ğŸ¯ Target: $TARGET_VM${SERVICE:+ â†’ $SERVICE}"
            bash deploy-to-vm.sh deploy "$TARGET_VM" "${SERVICE:-all}"
          elif [ -n "$SERVICE" ]; then
            # Service zu seiner konfigurierten VM deployen
            echo "ğŸ¯ Deploying service: $SERVICE"
            bash deploy-to-vm.sh service "$SERVICE"
          else
            # Alle VMs deployen
            echo "ğŸ¯ Target: All VMs"
            bash deploy-to-vm.sh deploy-all
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Deployment Summary
        if: success()
        run: |
          echo ""
          echo "ğŸ“‹ Deployment Summary:"
          echo "  Repository: ${{ github.repository }}"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  Commit: ${{ github.sha }}"
          echo "  Message: ${{ github.event.head_commit.message }}"
          echo "  Author: ${{ github.actor }}"
          echo ""

      - name: Deployment Failed
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ DEPLOYMENT FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Common issues:"
          echo "  â€¢ SSH connection to VM failed"
          echo "  â€¢ VM not configured in vms.yml"
          echo "  â€¢ Git pull failed (merge conflicts?)"
          echo "  â€¢ Docker errors on target VM"
          echo ""
          echo "Troubleshooting:"
          echo "  1. Check runner logs: docker compose logs"
          echo "  2. Test SSH: docker compose run --rm github-runner ssh <vm-name> hostname"
          echo "  3. Check vms.yml configuration"
          echo "  4. Check target VM: ssh <vm-name>"
          echo ""
          exit 1
