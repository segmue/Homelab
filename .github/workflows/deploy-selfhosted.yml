name: Deploy to Homelab (Self-hosted Runner)

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - 'scripts/**'
      - '.github/workflows/deploy-selfhosted.yml'

  workflow_dispatch:  # Erm√∂glicht manuelles Triggern √ºber GitHub UI

jobs:
  deploy:
    runs-on: self-hosted  # L√§uft auf deinem Runner!
    name: Deploy to Services VM

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy to Services VM
        run: |
          set -e
          echo "üì¶ Starting Homelab deployment..."
          echo "üñ•Ô∏è  Runner: $(hostname)"
          echo "üìÇ Workspace: $GITHUB_WORKSPACE"

          # SSH zur Services-VM und deployen
          ssh -F ~/.ssh/config services-vm << 'EOF'
            set -e

            echo "üîÑ Connected to Services VM: $(hostname)"

            # Zum Homelab-Verzeichnis navigieren
            HOMELAB_DIR="${HOMELAB_DIR:-$HOME/homelab}"

            if [ ! -d "$HOMELAB_DIR" ]; then
              echo "‚ùå Homelab directory not found at $HOMELAB_DIR"
              echo "Creating directory and cloning repository..."
              mkdir -p "$(dirname "$HOMELAB_DIR")"
              cd "$(dirname "$HOMELAB_DIR")"
              git clone https://github.com/${{ github.repository }}.git "$(basename "$HOMELAB_DIR")"
              cd "$HOMELAB_DIR"
            else
              cd "$HOMELAB_DIR"
            fi

            # Git pull (neueste √Ñnderungen holen)
            echo "üîÑ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main

            # Deployment-Skript ausf√ºhren
            echo "üöÄ Running deployment script..."
            if [ -f "scripts/deploy.sh" ]; then
              bash scripts/deploy.sh all update
            else
              echo "‚ö†Ô∏è  No deployment script found"
              exit 1
            fi

            echo "‚úÖ Deployment completed on Services VM!"
          EOF

          echo "‚úÖ Homelab deployment finished successfully!"

      - name: Deployment Success
        if: success()
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ DEPLOYMENT SUCCESSFUL"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä Commit: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"
          echo "üí¨ Message: ${{ github.event.head_commit.message }}"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚ùå DEPLOYMENT FAILED"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Check the logs above for details"
          echo "Common issues:"
          echo "  - SSH connection to Services VM failed"
          echo "  - Git pull failed (merge conflicts?)"
          echo "  - Deployment script failed"
          echo "  - Docker errors"
          exit 1
